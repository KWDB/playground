name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build_and_release:
    name: Build and publish GitHub Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Install frontend deps
        run: pnpm install --frozen-lockfile

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.24'

      - name: Build release binaries (Linux/macOS/Windows)
        run: |
          make release-all

      - name: Generate checksums
        run: |
          cd bin
          sha256sum kwdb-playground-* > checksums.txt
          ls -lh

      - name: Create distribution packages (zip/tar.gz)
        run: |
          make package-dist

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            bin/kwdb-playground-linux-amd64
            bin/kwdb-playground-linux-arm64
            bin/kwdb-playground-darwin-arm64
            bin/kwdb-playground-darwin-amd64
            bin/kwdb-playground-windows-amd64.exe
            bin/checksums.txt
            dist/kwdb-playground-linux-amd64.tar.gz
            dist/kwdb-playground-linux-arm64.tar.gz
            dist/kwdb-playground-darwin-arm64.tar.gz
            dist/kwdb-playground-darwin-amd64.tar.gz
            dist/kwdb-playground-windows-amd64.zip
            dist/distribution-checksums.txt
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          draft: false
          prerelease: ${{ contains(github.ref_name, '-rc') || contains(github.ref_name, '-beta') || contains(github.ref_name, '-alpha') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-homebrew-tap:
    name: Update Homebrew Formula
    runs-on: ubuntu-latest
    needs: build_and_release
    steps:
      - name: Get version from workflow run
        id: version
        run: |
          # Get the tag from the release
          TAG=${{ needs.build_and_release.outputs.version }}
          if [ -z "$TAG" ]; then
            TAG=${{ github.ref_name }}
          fi
          echo "VERSION=${TAG#v}" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Checkout main repo
        uses: actions/checkout@v4
        with:
          path: main-repo

      - name: Checkout tap repo
        uses: actions/checkout@v4
        with:
          repository: kwdb/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap
          fetch-depth: 0

      - name: Download release assets
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          cd homebrew-tap
          
          echo "Downloading assets for version v${VERSION}..."
          
          # Download assets
          gh release download "v${VERSION}" \
            --repo ${{ github.repository }} \
            --pattern "kwdb-playground-darwin-arm64.tar.gz" \
            --output "darwin-arm64.tar.gz"
          
          gh release download "v${VERSION}" \
            --repo ${{ github.repository }} \
            --pattern "kwdb-playground-darwin-amd64.tar.gz" \
            --output "darwin-amd64.tar.gz"

          gh release download "v${VERSION}" \
            --repo ${{ github.repository }} \
            --pattern "kwdb-playground-linux-arm64.tar.gz" \
            --output "linux-arm64.tar.gz"

          gh release download "v${VERSION}" \
            --repo ${{ github.repository }} \
            --pattern "kwdb-playground-linux-amd64.tar.gz" \
            --output "linux-amd64.tar.gz"

      - name: Calculate SHA256 checksums
        id: checksums
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          cd homebrew-tap
          
          DARWIN_ARM64_SHA=$(sha256sum darwin-arm64.tar.gz | cut -d' ' -f1)
          DARWIN_AMD64_SHA=$(sha256sum darwin-amd64.tar.gz | cut -d' ' -f1)
          LINUX_ARM64_SHA=$(sha256sum linux-arm64.tar.gz | cut -d' ' -f1)
          LINUX_AMD64_SHA=$(sha256sum linux-amd64.tar.gz | cut -d' ' -f1)
          
          echo "darwin_arm64_sha=$DARWIN_ARM64_SHA" >> $GITHUB_OUTPUT
          echo "darwin_amd64_sha=$DARWIN_AMD64_SHA" >> $GITHUB_OUTPUT
          echo "linux_arm64_sha=$LINUX_ARM64_SHA" >> $GITHUB_OUTPUT
          echo "linux_amd64_sha=$LINUX_AMD64_SHA" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          # Clean up downloaded assets
          rm *.tar.gz

      - name: Update formula
        env:
          VERSION: ${{ steps.checksums.outputs.version }}
          DARWIN_ARM64_SHA: ${{ steps.checksums.outputs.darwin_arm64_sha }}
          DARWIN_AMD64_SHA: ${{ steps.checksums.outputs.darwin_amd64_sha }}
          LINUX_ARM64_SHA: ${{ steps.checksums.outputs.linux_arm64_sha }}
          LINUX_AMD64_SHA: ${{ steps.checksums.outputs.linux_amd64_sha }}
        run: |
          cd homebrew-tap/Formula
          
          echo "Updating formula for version ${VERSION}..."
          
          # Use Ruby to update the formula file safely
          ruby -e "
            text = File.read('kwdb-playground.rb')
            
            # Update version
            version = ENV['VERSION']
            text.sub!(/version \"[^\"]*\"/, \"version \\\"#{version}\\\"\")
            
            # Define SHA256 values in the order they appear in the file
            # Order: macOS-ARM, macOS-Intel, Linux-ARM, Linux-Intel
            shas = [
              ENV['DARWIN_ARM64_SHA'],
              ENV['DARWIN_AMD64_SHA'],
              ENV['LINUX_ARM64_SHA'],
              ENV['LINUX_AMD64_SHA']
            ]
            
            idx = 0
            # Replace each sha256 occurrence
            text.gsub!(/sha256 \"[^\"]*\"/) do |match|
              if idx < shas.length
                new_sha = shas[idx]
                idx += 1
                \"sha256 \\\"#{new_sha}\\\"\"
              else
                match
              end
            end
            
            File.write('kwdb-playground.rb', text)
          "
          
          cat kwdb-playground.rb

      - name: Commit and push
        run: |
          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if [ -n "$(git status --porcelain)" ]; then
            git add Formula/kwdb-playground.rb
            git commit -m "Update kwdb-playground to v${{ steps.checksums.outputs.version }}"
            git push origin main
          else
            echo "No changes to commit"
          fi